{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\home\\controller\\signin.js"
    ],
    "names": [],
    "mappings": "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",
    "file": "..\\..\\..\\src\\home\\controller\\signin.js",
    "sourcesContent": [
        "'use strict';\r\n\r\nimport request from 'request';\r\n\r\nexport default class extends think.controller.base {\r\n\r\n    async indexAction() {\r\n        let is_login = await this.islogin();\r\n\r\n        if (is_login) {\r\n            this.redirect('/desktop');\r\n        }\r\n\r\n        if (this.isPost()) {\r\n\r\n            const _post = this.post();\r\n            const appusers = await this.model('appusers').where(_post).find();\r\n\r\n            if (appusers) {\r\n                this.model('appusers').where(_post).update({LastTime: think.datetime(), LastIp: this.ip()});\r\n\r\n                this.session('userInfo', appusers);\r\n            }\r\n\r\n            return this.redirect('/desktop');\r\n        }\r\n\r\n        let userInfo = {\r\n            UserId: '',\r\n            RemotePassword: ''\r\n        };\r\n\r\n\r\n        this.assign('userInfo', userInfo);\r\n        return this.display();\r\n    }\r\n\r\n    /*\r\n     * 新用户注册\r\n     *\r\n     * */\r\n    async registerAction() {\r\n        const _post = this.post();\r\n        const appusers = await this.model('appusers').thenAdd(_post, _post);\r\n        if (appusers.type != \"exist\") {\r\n            // 客户端服务器账号同步\r\n            // debug 在服务器没有开启时，json数据没有返回\r\n            think.log('客户端服务器账号同步', 'WARNING');\r\n            let userInfo = {UserId: _post.UserId, RemotePassword: _post.RemotePassword};\r\n            await this.syncallremoteusers(userInfo);\r\n\r\n            think.log('注册完成', 'WARNING');\r\n            return this.success(appusers, this.locale('query_success'));\r\n        }\r\n\r\n        return this.error(5000, this.locale('query_fail'));\r\n    }\r\n\r\n    /*\r\n     * 自动登录\r\n     *\r\n     * */\r\n    async autologinAction() {\r\n        const appusers = await this.model('appusers').autoLogin();\r\n        await this.session('userInfo', appusers);\r\n\r\n        //delete appusers.RemotePassword;\r\n\r\n        return this.success(appusers, this.locale('query_success'));\r\n    }\r\n\r\n    /*\r\n     * 退出登录\r\n     *\r\n     * */\r\n    async logoutAction() {\r\n        let is_login = await this.islogin();\r\n        if (is_login) {\r\n            this.session('userInfo', null);\r\n        }\r\n\r\n        this.redirect('/signin');\r\n    }\r\n\r\n    /*\r\n     * 是否已经登陆\r\n     *\r\n     * */\r\n    async islogin() {\r\n        let userInfo = await this.session('userInfo');\r\n        let result = think.isEmpty(userInfo) ? false : true;\r\n\r\n        return result;\r\n    }\r\n\r\n\r\n    async syncallremoteusersAction() {\r\n        const _userInfo = await this.session('userInfo');\r\n        const _syncallremoteusers = await this.syncallremoteusers(_userInfo);\r\n\r\n        return this.json(_syncallremoteusers);\r\n    }\r\n\r\n    /*\r\n     * 同步当前用户，用户需要登陆\r\n     *\r\n     * */\r\n    async syncallremoteusers(userInfo) {\r\n        const server = await this.model('server').select();\r\n        const config = await this.model('config').find();\r\n\r\n        let resultRemote = [];\r\n        let params = {\r\n            key: config.apiKey,\r\n            username: userInfo.UserId,\r\n            password: userInfo.RemotePassword\r\n        };\r\n\r\n\r\n        for (var i in server) {\r\n\r\n            let url = 'http://' + server[i].ip + ':' + server[i].port + '/setuser.asp?' + this.setUrlParam(params);\r\n            let resultData = await this.getApiData(url);\r\n\r\n            if (resultData.statusCode == 200) {\r\n                resultRemote.push({\r\n                    key: config.apiKey,\r\n                    username: userInfo.UserId,\r\n                    ip: server[i].ip,\r\n                    status: false,\r\n                    msg: this.locale('sync_success')\r\n                });\r\n\r\n                think.log('客户端服务器账号同步：' + server[i].ip + this.locale('sync_success'), 'WARNING');\r\n            } else {\r\n                resultRemote.push({\r\n                    key: config.apiKey,\r\n                    username: userInfo.UserId,\r\n                    ip: server[i].ip,\r\n                    status: false,\r\n                    msg: this.locale('sync_fail')\r\n                });\r\n\r\n                think.log('客户端服务器账号同步：' + server[i].ip + this.locale('sync_fail'), 'WARNING');\r\n            }\r\n        }\r\n\r\n        return this.success(resultRemote, this.locale('query_success'));\r\n    }\r\n\r\n\r\n    setUrlParam(obj) {\r\n        let str = [];\r\n\r\n        for (var i in obj) {\r\n            str.push(i + '=' + encodeURIComponent(obj[i]));\r\n        }\r\n\r\n        return str.join('&');\r\n    }\r\n\r\n    getApiData(url) {\r\n        let fn = think.promisify(request.get);\r\n        return fn({\r\n            url: url,\r\n            headers: {\r\n                \"User-Agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) Chrome/47.0.2526.111 Safari/537.36\"\r\n            }\r\n        });\r\n    }\r\n\r\n}"
    ]
}